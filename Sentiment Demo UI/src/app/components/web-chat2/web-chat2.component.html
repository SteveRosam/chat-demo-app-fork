<section fxLayout="column" fxLayoutAlign="center center" fxLayout.lt-md="column" fxFlexFill class="background">
  
  <mat-card fxLayout="column" class="chat-card w-100" [style.maxWidth.px]="440">
    <mat-card-header fxLayout="row" fxLayoutAlign="space-between center">
        <p class="fw-bold m-0 me-2">{{ quixService.selectedRoom }}</p>
        <div fxLayout="row" fxLayoutAlign="start center">
          <mat-chip-list aria-label="Fish selection" class="me-2">
            <mat-chip class="status-chip">
              <mat-icon fontIcon="circle" class="status-icon" 
              [class.text-success]="readerConnectionStatus === connectionState.Connected"
              [class.text-warning]="readerConnectionStatus === connectionState.Reconnecting"
              [class.text-danger]="readerConnectionStatus === connectionState.Offline"></mat-icon>
              <strong [style.marginLeft.px]="5">{{ readerConnectionStatus }}</strong>
            </mat-chip>
          </mat-chip-list> 
          <button mat-flat-button class="small mat-elevation-z4" color="primary" (click)="openShareChatroomDialog()">
            <mat-icon inline fontIcon="share" class="material-icons-outlined me-1" [style.fontSize.px]="16"></mat-icon>
            Share
          </button>
        </div>
    </mat-card-header>
    <mat-card-content fxFlex fxLayout="column" class="bg-white overflow-hidden">
      <div fxFlex class="overflow-auto"  #chatWrapper>
        <div fxLayout="column" class="_message py-1 px-2 m-3 rounded-3 overflow-hidden" *ngFor="let message of messages">
          <div fxFlex fxLayout="row" fxLayoutAlign="start start">
            <div class="profile-pic me-2">
              <img [src]="message.profilePic" height="32">
            </div>
            <div fxLayout="column">
              <p class="mb-0 fw-bold mat-body-2">{{ message.name }}</p>
              <div>{{ message.value }}</div>
            </div>
          </div>
          <div fxLayout="row" fxLayoutAlign="end center" class="mat-caption">
            <p class="mb-0 me-2 text-grey-light mat-caption"> {{ getDateFromTimestamp(message.timestamp) | date:'hh:mm:ss' }}</p>
            <div 
              [class]="getColor(message?.sentiment!)" fxLayout="row" fxLayoutAlign="start center">
              <mat-icon inline class="material-icons-outlined me-1" [style.fontSize.px]="16">
                {{ getSentimentClass(message?.sentiment!) }}
              </mat-icon>
              <p class="mb-0 fw-bold">{{ (message.sentiment! > 0 ? '+' : '') + (message.sentiment | number : '1.2-2') }}</p>
            </div>
          </div>
        </div>        
      </div>

      <div fxLayout="row" fxLayoutAlign="space-between center" class="mat-caption my-2 mx-3">
        <div fxLayout="row">
          <div *ngIf="happy" fxLayout="row" fxLayoutAlign="start center" class="text-success me-2" matTooltip="Chris, John">
            <mat-icon inline fontIcon="sentiment_satisfied" class="material-icons-outlined icon14" [style.fontSize.px]="16"></mat-icon>
            <span class="fw-bold">{{ happy }}</span>
          </div>
          <div *ngIf="unhappy" fxLayout="row" fxLayoutAlign="start center" class="text-danger me-2" matTooltip="Mike">
            <mat-icon inline fontIcon="sentiment_dissatisfied" class="material-icons-outlined icon14" [style.fontSize.px]="16"></mat-icon>
            <span class="fw-bold">{{ unhappy }}</span>
          </div>
        
          <!-- <div *ngIf="getTypingMessage() as message" class="mat-caption typing">
            <div [innerHTML]="message"></div>
          </div> -->
        </div>
        <span>avg: <span class="fw-bold">{{  (averageSentiment > 0 ? '+' : '') + averageSentiment | number : '1.2-2' }}</span></span>
      </div>
    </mat-card-content>
    <mat-card-footer>

      <!-- Twitch - Read Only -->
      <!-- <p class="mb-0 fw-bold text-uppercase">Read only</p> -->

      <form [formGroup]="chatForm" fxLayout="row" fxLayoutGap="10" autocomplete="off" (ngSubmit)="submit()"> 

        <!-- Username empty - Prompt user to enter username before they enter chat -->
        <ng-container *ngIf="!username">
          <mat-form-field appearance="outline" fxFlex class="small pb-0" [hideRequiredMarker]="true">
            <mat-label>Enter your username</mat-label>
            <input matInput [formControl]="usernameFC">
          </mat-form-field>
          <button mat-flat-button color="primary" class="ms-2" (click)="username = usernameFC.value!" [disabled]="usernameFC.invalid"> 
            Join chat
          </button>
        </ng-container>

        <!-- Username provided - Allow user to send messages -->
        <div fxFlex fxLayout="row" fxLayoutAlign="start center" *ngIf="username">
          <div class="profile-pic me-2">
            <img [src]="profilePic" height="32">
          </div>
          <mat-form-field appearance="outline" fxFlex class="_message-input me-2 pb-0">
            <input matInput placeholder="Type your message" formControlName="message">
          </mat-form-field>
          <button mat-mini-fab color="primary" type="submit" class="mat-elevation-z0" [disabled]="!chatForm.controls.message.value">
            <mat-icon>send</mat-icon>
          </button>
        </div>

      </form>
    </mat-card-footer>
  </mat-card>
</section>  